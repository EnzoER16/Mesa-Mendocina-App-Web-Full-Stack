{% extends 'base.html' %}
{% block title %}{{ location.name }} ¬∑ Mesa Mendocina{% endblock %}

{% block content %}

    <div class="container mt-5">
        <!-- informacion del local -->
        <div class="card bg-dark text-light shadow-lg p-4 mb-5 border-0">

            <div class="row mb-4 align-items-center">
                <div class="col-md-6 text-center">
                    <img src="{{ url_for('static', filename='img/locations/' + (location.image or 'no_image.png')) }}"
                        alt="Imagen del local {{ location.name }}"
                        class="img-fluid rounded shadow w-100"
                        style="max-height: 350px; object-fit: cover;">
                </div>

                <div class="col-md-6">
                    <div id="map" style="height: 350px; border-radius: 10px;" class="shadow"></div>
                </div>
            </div>

            <h2 class="text-center text-success mb-3">{{ location.name }}</h2>
            <p><strong>Direcci√≥n:</strong> {{ location.address }}</p>
            <p><strong>Departamento:</strong> {{ location.department }}</p>
            <p><strong>Tel√©fono:</strong> {{ location.phone }}</p>

            {% if location.description %}
                <hr class="border-secondary">
                <p class="fst-italic">{{ location.description }}</p>
            {% endif %}

            {% if session.get('role') == 'owner' and session.get('user_id') == location.id_user %}
                <div class="text-center mt-4">
                    <a href="{{ url_for('plates.create_plate', id_location=location.id_location) }}" class="btn btn-outline-success me-2">
                    Agregar plato</a>

                </div>
            {% endif %}
        </div>

        <!-- platos -->
        <h3 class="text-light mb-3">Platos disponibles</h3>
        <div class="row">
            {% for plate in location.plates %}
                <div class="col-md-4 mb-4">
                    <div class="card bg-dark text-light h-100 border-0 shadow">
                        <img src="{{ url_for('static', filename='img/plates/' + (plate.image or 'no_image.png')) }}"
                            class="card-img-top"
                            alt="Imagen del plato {{ plate.name }}"
                            style="height: 200px; object-fit: cover;">
                            
                        <div class="card-body">
                            <h5>{{ plate.name }}</h5>
                            {% if plate.description %}
                                <p>{{ plate.description }}</p>
                            {% endif %}
                            <p><strong>${{ '%.2f'|format(plate.price) }}</strong></p>

                            {% if session.get('role') == 'owner' and session.get('user_id') == location.id_user %}
                                <div class="mt-3 d-flex flex-wrap gap-2 justify-content-center">
                                    <a href="{{ url_for('plates.edit_plate', id_plate=plate.id_plate) }}" class="btn btn-sm btn-outline-warning">
                                        Editar
                                    </a>
                                    <form action="{{ url_for('plates.delete_plate', id_plate=plate.id_plate) }}" method="POST"
                                        onsubmit="return confirm('¬øSeguro que quieres eliminar este plato?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            Eliminar
                                        </button>
                                    </form>
                                </div>
                            {% endif %}
                        </div>

                    </div>
                </div>
            {% else %}
                <div class="text-center">
                    <p>No hay platos registrados a√∫n.</p>
                </div>
            {% endfor %}
        </div>

        <!-- rese√±as -->
        
        <hr class="border-secondary my-5">
        <h3 class="text-light mb-4">Rese√±as</h3>

        {% if session.get('role') == 'user' %}
            <a href="{{ url_for('ratings.create_rating', id_location=location.id_location) }}" class="btn btn-success mb-4">
                Dejar rese√±a
            </a>
        {% endif %}

        {% if location.ratings %}
            <div class="row g-4">
                {% for rating in location.ratings %}
                    <div class="col-md-6">
                        <div class="card bg-dark text-light shadow-sm h-100 border-0">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>{{ rating.user.username }}</strong>
                                    <span class="badge bg-warning text-dark">‚òÜ {{ rating.rate }}/5</span>
                                </div>
                                <p class="mb-2">{{ rating.comment }}</p>
                                <small class="text-muted">{{ rating.date }}</small>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text mt-4">No hay rese√±as a√∫n.</p>
        {% endif %}
        
        <!-- reservar -->
        {% if session.get('role') == 'user' %}
            <hr class="border-secondary my-5">
            <h3 class="text-light mb-3">Reservar mesa</h3>
            <a href="{{ url_for('reservations.create_reservation', id_location=location.id_location) }}" 
            class="btn btn-primary btn-lg shadow">
                Reservar ahora
            </a>
        {% endif %}

    </div>


    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const address = '{{ location.address | tojson }}';
        let routingControl = null;

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address + ', Mendoza, Argentina')}`)
            .then(response => response.json())
            .then(data => {
                if (data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);

                    const map = L.map('map').setView([lat, lon], 14);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
                    }).addTo(map);

                    const destination = L.latLng(lat, lon);
                    L.marker(destination)
                        .addTo(map)
                        .bindPopup(`<strong>{{ location.name }}</strong><br>${address}`)
                        .openPopup();

                    // üß≠ Crear un bot√≥n dentro del mapa
                    const DirectionsButton = L.Control.extend({
                        options: { position: 'bottomleft' }, // 'topleft', 'topright', 'bottomleft', 'bottomright'
                        onAdd: function(map) {
                            const btn = L.DomUtil.create('button', 'leaflet-bar leaflet-control leaflet-control-custom');
                            btn.innerHTML = 'üó∫Ô∏è C√≥mo llegar';
                            btn.style.backgroundColor = '#0d6efd';
                            btn.style.color = 'white';
                            btn.style.border = 'none';
                            btn.style.cursor = 'pointer';
                            btn.style.padding = '5px 10px';
                            btn.style.fontSize = '13px';
                            btn.style.borderRadius = '4px';

                            // Evita que el clic haga zoom en el mapa
                            L.DomEvent.disableClickPropagation(btn);

                            btn.onclick = function() {
                                if (!navigator.geolocation) {
                                    alert("Tu navegador no soporta geolocalizaci√≥n.");
                                    return;
                                }

                                navigator.geolocation.getCurrentPosition(function(position) {
                                    const userLocation = L.latLng(position.coords.latitude, position.coords.longitude);

                                    // Agregar marcador de usuario
                                    L.marker(userLocation, { title: "Tu ubicaci√≥n" })
                                        .addTo(map)
                                        .bindPopup("üìç Est√°s aqu√≠")
                                        .openPopup();

                                    // Eliminar ruta anterior si existe
                                    if (routingControl) {
                                        map.removeControl(routingControl);
                                    }

                                    // Mostrar la ruta
                                    routingControl = L.Routing.control({
                                        waypoints: [userLocation, destination],
                                        routeWhileDragging: false,
                                        addWaypoints: false,
                                        draggableWaypoints: false,
                                        fitSelectedRoutes: true,
                                        lineOptions: {
                                            styles: [{ color: '#3F48CC', weight: 5 }]
                                        },
                                        createMarker: function() { return null; },
                                        show: false
                                    }).addTo(map);


    // Esperar un poco y luego cambiar el color por JS
    setTimeout(() => {
        const container = document.querySelector('.leaflet-routing-container');
        if (container) {
            container.style.color = '#fff';
            container.style.backgroundColor = '#333';
        }
    }, 500);

                                }, function() {
                                    alert("No se pudo obtener tu ubicaci√≥n.");
                                });
                            };

                            return btn;
                        }
                    });

                    map.addControl(new DirectionsButton());
                } else {
                    document.getElementById('map').innerHTML =
                        '<p class="text-light">No se pudo localizar la direcci√≥n en el mapa.</p>';
                }
            })
            .catch(err => {
                console.error(err);
                document.getElementById('map').innerHTML =
                    '<p class="text-light">Error al cargar el mapa.</p>';
            });
    });
    </script>

{% endblock %}