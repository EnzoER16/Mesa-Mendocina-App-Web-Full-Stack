{% extends 'base.html' %}
{% block title %}Reservaciones · Mesa Mendocina{% endblock %}

{% block content %}

    <div class="d-flex justify-content-center mt-5">
        <div class="border border-dark p-4 rounded bg-dark text-light" style="width: 80%;">
            <h2 class="text-center mb-4">Reservaciones</h2>

            <table class="table table-striped table-dark table-bordered align-middle text-center">
                <thead>
                    <tr>
                        <th class="sortable">Local <span class="sort-icon">▲▼</span></th>
                        {% if session.get('role') == 'owner' %}
                            <th>Usuario</th>
                        {% endif %}
                        <th class="sortable">Fecha <span class="sort-icon">▲▼</span></th>
                        <th class="sortable">Hora <span class="sort-icon">▲▼</span></th>
                        <th class="sortable">Personas <span class="sort-icon">▲▼</span></th>
                        <th class="sortable">Estado <span class="sort-icon">▲▼</span></th>
                        <th>Acciones</th>
                    </tr>
                </thead>

                <tbody>
                    {% for r in reservations %}
                    <tr>
                        <td class="text-start">{{ r.location.name }}</td>
                        {% if session.get('role') == 'owner' %}
                            <td>{{ r.user.username }}</td>
                        {% endif %}
                        <td>{{ r.date }}</td>
                        <td>{{ r.time }}</td>
                        <td>{{ r.people }}</td>
                        <td>
                            {% if r.status == 'accepted' %}
                                <span class="badge bg-success">Aceptada</span>
                            {% elif r.status == 'rejected' %}
                                <span class="badge bg-danger">Rechazada</span>
                            {% elif r.status == 'cancelled' %}
                                <span class="badge bg-secondary">Cancelada</span>
                            {% else %}
                                <span class="badge bg-warning">Pendiente</span>
                            {% endif %}
                        </td>

                        <td>
                            <a href="{{ url_for('reservations.view_reservation', id_reservation=r.id_reservation) }}" class="btn btn-outline-primary btn-sm">Ver estado</a>
                        </td>
                    </tr>

                    {% else %}

                    <tr>
                        <td colspan="{% if session.get('role') == 'owner' %}6{% else %}5{% endif %}" class="text-center">No hay reservaciones.</td>
                    </tr>
                    {% endfor %}

                </tbody>
            </table>

            <div class="text-center mt-4">
                <a href="{{ url_for('public') }}" class="btn btn-outline-light">Volver</a>
            </div>
        </div>
    </div>

    <script>
        document.querySelectorAll("th.sortable").forEach(th => {
            th.addEventListener("click", function() {
                const table = th.closest("table");
                const tbody = table.querySelector("tbody");
                const index = Array.from(th.parentNode.children).indexOf(th);
                const rows = Array.from(tbody.querySelectorAll("tr"));
                const asc = !th.classList.contains("asc");

                // ordenar filas
                rows.sort((a, b) => {
                    const aText = a.children[index].innerText.trim();
                    const bText = b.children[index].innerText.trim();
                    return asc ? aText.localeCompare(bText, 'es', { numeric: true }) :
                                bText.localeCompare(aText, 'es', { numeric: true });
                });

                tbody.innerHTML = "";
                rows.forEach(row => tbody.appendChild(row));

                // resetear flechas
                document.querySelectorAll("th.sortable").forEach(th => {
                    th.classList.remove("asc", "desc");
                    const icon = th.querySelector(".sort-icon");
                    if (icon) icon.textContent = "▲▼"; // estado inicial
                });

                // marcar la columna
                th.classList.toggle("asc", asc);
                th.classList.toggle("desc", !asc);
                const icon = th.querySelector(".sort-icon");
                if (icon) icon.textContent = asc ? "▲" : "▼"; // actualizar según orden
            });
        });
    </script>

{% endblock %}